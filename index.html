<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>現在地からランダム散歩（APIキー不要）</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background: #eef7f3;
    }
    #map {
      height: 80vh;
    }
    select, button {
      padding: 6px;
      margin-right: 8px;
    }
  </style>
</head>
<body>

<div id="controls">
  <select id="distance">
    <option value="1">1km</option>
    <option value="2">2km</option>
    <option value="3">3km</option>
    <option value="5">5km</option>
  </select>

  <button onclick="generateRoute()">現在地から散歩する</button>
</div>

<div id="map"></div>

<script>
const FALLBACK_LOCATION = { lat: 33.5597, lng: 133.5311 }; // 高知城

const map = L.map("map").setView(
  [FALLBACK_LOCATION.lat, FALLBACK_LOCATION.lng],
  13
);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

let routeLayer;

// 現在地取得（失敗時はフォールバック）
function getCurrentLocation() {
  return new Promise(resolve => {
    if (!navigator.geolocation) {
      resolve(FALLBACK_LOCATION);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        resolve({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        });
      },
      () => resolve(FALLBACK_LOCATION),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

// 距離とランダム角度からゴール生成
function createRandomGoal(lat, lng, distanceKm) {
  const angle = Math.random() * Math.PI * 2;
  const delta = distanceKm * 0.009;

  return {
    lat: lat + Math.cos(angle) * delta,
    lng: lng + Math.sin(angle) * delta
  };
}

async function generateRoute() {
  if (routeLayer) {
    map.removeLayer(routeLayer);
  }

  const distanceKm = Number(document.getElementById("distance").value);
  const start = await getCurrentLocation();
  const goal = createRandomGoal(start.lat, start.lng, distanceKm);

  map.setView([start.lat, start.lng], 15);

  const url =
    `https://router.project-osrm.org/route/v1/foot/` +
    `${start.lng},${start.lat};${goal.lng},${goal.lat}` +
    `?overview=full&geometries=geojson`;

  const res = await fetch(url);
  const data = await res.json();

  if (!data.routes || !data.routes.length) {
    alert("ルートを生成できませんでした");
    return;
  }

  routeLayer = L.layerGroup().addTo(map);

  L.geoJSON(data.routes[0].geometry, {
    style: { weight: 5 }
  }).addTo(routeLayer);

  L.marker([start.lat, start.lng])
    .addTo(routeLayer)
    .bindPopup("スタート（現在地）")
    .openPopup();

  L.marker([goal.lat, goal.lng])
    .addTo(routeLayer)
    .bindPopup("ゴール");

  map.fitBounds(routeLayer.getBounds());
}
</script>

</body>
</html>
