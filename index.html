<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>気分で決まるランダム散歩</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background: #eef7f3;
    }
    #map {
      height: 80vh;
    }
    select, button {
      padding: 6px;
      margin-right: 8px;
    }
  </style>
</head>
<body>

<div id="controls">
  <select id="mood">
    <option value="relax">のんびり</option>
    <option value="city">街歩き</option>
    <option value="adventure">冒険</option>
  </select>

  <select id="distance">
    <option value="1">1km</option>
    <option value="2">2km</option>
    <option value="3">3km</option>
    <option value="5">5km</option>
  </select>

  <button onclick="generateRoute()">散歩ルートを決める</button>
</div>

<div id="map"></div>

<script>
// 位置取得失敗時の保険（高知城）
const FALLBACK_LOCATION = { lat: 33.5597, lng: 133.5311 };

// 気分ごとのランダム性設定
const MOOD_SETTINGS = {
  relax: {
    angleRange: Math.PI / 3,   // 方向ブレ小
    distanceRate: 0.8
  },
  city: {
    angleRange: Math.PI,       // 中くらい
    distanceRate: 1.0
  },
  adventure: {
    angleRange: Math.PI * 2,   // 完全ランダム
    distanceRate: 1.2
  }
};

const map = L.map("map").setView(
  [FALLBACK_LOCATION.lat, FALLBACK_LOCATION.lng],
  13
);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

let routeLayer;

// 現在地取得
function getCurrentLocation() {
  return new Promise(resolve => {
    if (!navigator.geolocation) {
      resolve(FALLBACK_LOCATION);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        resolve({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        });
      },
      () => resolve(FALLBACK_LOCATION),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

// 気分 × 距離でゴール生成
function createRandomGoal(lat, lng, distanceKm, mood) {
  const setting = MOOD_SETTINGS[mood];

  const baseAngle = Math.random() * 2 * Math.PI;
  const angle =
    baseAngle +
    (Math.random() - 0.5) * setting.angleRange;

  const delta =
    distanceKm * setting.distanceRate * 0.009;

  return {
    lat: lat + Math.cos(angle) * delta,
    lng: lng + Math.sin(angle) * delta
  };
}

async function generateRoute() {
  if (routeLayer) {
    map.removeLayer(routeLayer);
  }

  const mood = document.getElementById("mood").value;
  const distanceKm = Number(document.getElementById("distance").value);

  const start = await getCurrentLocation();
  const goal = createRandomGoal(
    start.lat,
    start.lng,
    distanceKm,
    mood
  );

  map.setView([start.lat, start.lng], 15);

  const url =
    `https://router.project-osrm.org/route/v1/foot/` +
    `${start.lng},${start.lat};${goal.lng},${goal.lat}` +
    `?overview=full&geometries=geojson`;

  const res = await fetch(url);
  const data = await res.json();

  if (!data.routes || !data.routes.length) {
    alert("ルートを生成できませんでした");
    return;
  }

  routeLayer = L.layerGroup().addTo(map);

  L.geoJSON(data.routes[0].geometry, {
    style: { weight: 5 }
  }).addTo(routeLayer);

  L.marker([start.lat, start.lng])
    .addTo(routeLayer)
    .bindPopup("スタート（現在地）")
    .openPopup();

  L.marker([goal.lat, goal.lng])
    .addTo(routeLayer)
    .bindPopup("ゴール");

  map.fitBounds(routeLayer.getBounds());
}
</script>

</body>
</html>
